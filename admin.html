<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة الأدمن - الطيبات</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<style>
.admin-area{max-width:1200px;margin:40px auto}
.admin-card{border-radius:12px}
.stat-box{border-radius:12px;padding:20px;text-align:center;}
.stat-num{font-size:26px;font-weight:bold;color:#c00}
#statProducts { background-color: #ffe0e0; }
#statOrders { background-color: #e0ffe0; }
#statMoney  { background-color: #e0e0ff; }
#statFeedback { background-color: #fff0b3; }
</style>
</head>
<body>

<header class="bg-danger py-2">
  <div class="container d-flex justify-content-between align-items-center">
    <a href="index.html" class="text-white fw-bold fs-4">🍯 الطيبات</a>
    <div class="text-white">لوحة الإدارة</div>
  </div>
</header>

<div class="admin-area container">

<!-- Login -->
<div id="loginBox" class="card p-4 admin-card mb-4">
<h5>تسجيل دخول الأدمن</h5>
<div class="row g-2">
<div class="col-md-6"><input id="adminPass" class="form-control" placeholder="كلمة المرور"></div>
<div class="col-md-6 d-grid"><button id="loginBtn" class="btn btn-danger">دخول</button></div>
</div>
<small class="text-muted mt-2 d-block">كلمة المرور: admin123</small>
</div>

<div id="adminArea" style="display:none">

<!-- إضافة / تعديل منتج -->
<div class="row mb-4">
<div class="col-lg-8">
<div class="card p-3 admin-card">
<h5>إضافة / تعديل منتج</h5>
<form id="prodForm" class="row g-2">
<div class="col-12"><input id="prodName" class="form-control" placeholder="اسم المنتج" required></div>
<div class="col-6"><input id="prodPrice" type="number" class="form-control" placeholder="السعر" required></div>
<div class="col-6"><input id="prodImg" type="file" class="form-control"></div>
<div class="col-12"><textarea id="prodDesc" class="form-control" placeholder="وصف قصير"></textarea></div>
<div class="col-12 d-grid"><button class="btn btn-warning" type="submit">حفظ المنتج</button></div>
</form>
</div>
</div>

<!-- الإحصائيات -->
<div class="col-lg-4">
<div class="card p-3 admin-card">
<h5 class="text-center mb-3">📊 الإحصائيات</h5>
<div class="stat-box mb-2">عدد المنتجات<div id="statProducts" class="stat-num">0</div></div>
<div class="stat-box mb-2">عدد الطلبات<div id="statOrders" class="stat-num">0</div></div>
<div class="stat-box mb-2">إجمالي المبيعات<div id="statMoney" class="stat-num">0 ج.م</div></div>
<div class="stat-box">عدد الشكاوي<div id="statFeedback" class="stat-num">0</div></div>
</div>
</div>
</div>

<!-- قائمة المنتجات -->
<div class="card p-3 admin-card mb-4">
<h5>قائمة المنتجات</h5>
<div id="adminProducts" class="row g-3"></div>
</div>

<!-- الطلبات الواردة -->
<div class="card p-3 admin-card mb-4">
<h5>الطلبات الواردة</h5>
<div class="table-responsive mt-2">
<table class="table table-bordered">
<thead class="table-danger">
<tr><th>رقم</th><th>عميل</th><th>هاتف</th><th>العنوان</th><th>الإجمالي</th><th>عرض</th><th>حذف</th></tr>
</thead>
<tbody id="ordersBody"></tbody>
</table>
</div>
</div>

<!-- الشكاوي والاقتراحات -->
<div class="card p-3 admin-card mb-4">
<h5>الشكاوي والاقتراحات</h5>
<div id="feedbackList"></div>
</div>

</div>
</div>

<!-- مكتبة jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


<script>
/* 🟥 Login */
const loginBox=document.getElementById('loginBox');
const adminArea=document.getElementById('adminArea');
const loginBtn=document.getElementById('loginBtn');
const adminPass=document.getElementById('adminPass');

loginBtn.addEventListener('click', loginAdmin);
adminPass.addEventListener('keypress', e=>{ if(e.key==='Enter') loginAdmin(); });

function loginAdmin(){
if(adminPass.value==='admin123'){
loginBox.style.display='none';
adminArea.style.display='block';
loadAdmin();
}else alert('كلمة المرور خاطئة');
}

/* 🟥 LocalStorage Shortcuts */
const fetchProducts=()=>JSON.parse(localStorage.getItem('et_products')||'[]');
const saveProducts=arr=>localStorage.setItem('et_products',JSON.stringify(arr));
const fetchOrders=()=>JSON.parse(localStorage.getItem('et_orders')||'[]');
const saveOrders=arr=>localStorage.setItem('et_orders',JSON.stringify(arr));
const fetchFeedback=()=>JSON.parse(localStorage.getItem('et_feedback')||'[]');
const saveFeedback=arr=>localStorage.setItem('et_feedback',JSON.stringify(arr));

/* 🟥 Dashboard Loader */
function loadAdmin(){
renderAdminProducts();
renderAdminOrders();
renderFeedback();
updateStats();
}

/* 🟩 Stats Update */
function updateStats(){
const p=fetchProducts();
const o=fetchOrders();
const f=fetchFeedback();
let money=0; o.forEach(x=>money+=x.total||0);
document.getElementById('statProducts').innerText=p.length;
document.getElementById('statOrders').innerText=o.length;
document.getElementById('statMoney').innerText=money+' ج.م';
document.getElementById('statFeedback').innerText=f.length;
}

/* 🟨 Product CRUD */
let editIndex=null;
document.getElementById('prodForm').addEventListener('submit', e=>{
e.preventDefault();
const name=document.getElementById('prodName').value.trim();
const price=parseFloat(document.getElementById('prodPrice').value)||0;
const desc=document.getElementById('prodDesc').value.trim();
let img='assets/placeholder.jpg';
const fileInput=document.getElementById('prodImg');
if(fileInput.files && fileInput.files[0]){
const reader=new FileReader();
reader.onload=function(e){ img=e.target.result; saveProductAndRender(name,price,img,desc); }
reader.readAsDataURL(fileInput.files[0]);
}else saveProductAndRender(name,price,img,desc);
});

function saveProductAndRender(name,price,img,desc){
const arr=fetchProducts();
if(editIndex!==null){ arr[editIndex]={...arr[editIndex],name,price,img,desc}; editIndex=null; } 
else arr.unshift({id:Date.now(),name,price,img,desc});
saveProducts(arr); document.getElementById('prodForm').reset(); renderAdminProducts(); updateStats();
}

function renderAdminProducts(){
const arr=fetchProducts(); const box=document.getElementById('adminProducts'); box.innerHTML='';
arr.forEach((p,i)=>{
box.innerHTML+=`
<div class="col-12">
<div class="d-flex justify-content-between border p-2 rounded align-items-center">
<div>
<strong>${p.name}</strong><br><span class="text-danger">${p.price} ج.م</span><br>${p.desc}
</div>
<div>
<button class="btn btn-sm btn-primary" onclick="editProd(${i})">تعديل</button>
<button class="btn btn-sm btn-danger" onclick="delProd(${i})">حذف</button>
</div>
</div></div>`; });
}

function editProd(i){
const arr=fetchProducts(); const p=arr[i];
document.getElementById('prodName').value=p.name;
document.getElementById('prodPrice').value=p.price;
document.getElementById('prodDesc').value=p.desc;
editIndex=i;
}

function delProd(i){
if(!confirm('حذف؟'))return;
const arr=fetchProducts(); arr.splice(i,1);
saveProducts(arr); renderAdminProducts(); updateStats();
}

/* 🟦 Orders */
function renderAdminOrders(){
const o=fetchOrders();
const body=document.getElementById('ordersBody'); body.innerHTML='';
o.forEach((or,i)=>{
body.innerHTML+=`<tr>
<td>${or.id||i+1}</td>
<td>${or.name}</td>
<td>${or.phone}</td>
<td>${or.address}</td>
<td>${or.total||0} ج.م</td>
<td><button class="btn btn-sm btn-primary" onclick="viewOrder(${i})">👁</button></td>
<td><button class="btn btn-sm btn-danger" onclick="deleteOrder(${i})">🗑</button></td>
</tr>`;
});
updateStats();
}

function viewOrder(i){
  const o = fetchOrders()[i];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
  let y = 40;
  
  doc.setFontSize(18);
  doc.text(`فاتورة طلب رقم ${o.id||i+1}`, 40, y);
  y += 30;

  doc.setFontSize(14);
  doc.text(`العميل: ${o.name}`, 40, y); y+=20;
  doc.text(`الهاتف: ${o.phone}`, 40, y); y+=20;

  let addr = o.address || "لا يوجد عنوان";
  if(addr.startsWith("https://www.google.com/maps")) addr = "موقع العميل";
  doc.text(`العنوان: ${addr}`, 40, y); y+=30;

  doc.text(`المنتجات:`, 40, y); y+=20;
  (o.items||[]).forEach(item=>{
    doc.text(`- ${item.name} | الكمية: ${item.qty} | السعر: ${item.price} ج.م`, 40, y);
    y += 20;
  });

  y += 10;
  doc.text(`الإجمالي: ${o.total||0} ج.م`, 40, y);

  // فتح نافذة جديدة للمعاينة مع خيارات الطباعة والحفظ
  const pdfData = doc.output('bloburl');
  window.open(pdfData, '_blank');
}


function deleteOrder(i){
if(!confirm('حذف؟'))return;
const arr=fetchOrders(); arr.splice(i,1);
saveOrders(arr); renderAdminOrders(); updateStats();
}

/* 🟨 Feedback */
function renderFeedback(){
const arr=fetchFeedback(); const box=document.getElementById('feedbackList'); box.innerHTML='';
if(arr.length===0){ box.innerHTML='<p class="text-muted">لا توجد رسائل</p>'; return; }
arr.forEach((f,i)=>{
box.innerHTML+=`<div class="border p-2 mb-2 rounded">
<strong>${f.name} (${f.type})</strong> — <small>${f.date}</small><br>${f.msg}
<button class="btn btn-sm btn-danger float-end" onclick="deleteFeedback(${i})">حذف</button>
</div>`; });
}

function deleteFeedback(i){
const arr=fetchFeedback(); arr.splice(i,1);
saveFeedback(arr); renderFeedback(); updateStats();
}

window.addEventListener('load',()=>{});


</script>

</body>
</html>
